Todayâ€™s Topics
1. Revision of 
 - Spring MVC Flow
 -  Model Attributes , ModelAndView 
 - Spring MVC Hibernate integration - (w/o spring boot)
  - With Controller , Service , DAO , Entity & DB layers
 - Task 
  - List Departments

2. Enter Spring Boot & port existing application to spring boot.

3. Enter Spring Data JPA



   
Identify  the efforts of extensive configuration.
 - To reduce these efforts 
  - Enter Spring Boot , for MVC based web app (monolithic) - project technology
  MVC Flow with concepts n steps 
1. Integration of Spring MVC with hibernate.
Refer to flow diagram n code n steps 
1.1 Spring MVC Flow diagram
1.2 Detailed Controller-Service-DAO-Entities-DB diagram.
2.   Explain what happens internally , when you start(deploy) Spring MVC Hibernate based web app on the web server ?
2.1 WC starts life cycle of D.S
2.2 In init() -> 
Start the SC in web app , using hybrid approach
2.3 SC uses defaults for it's start up
name - servletName-servlet.xml (eg - spring-servlet.xml) => master config file
location - WEB-INF
contents - xml tags 
2.4 import - hibernate-persistence.xml
Contents - Configuration of 3 spring beans.
DBCP bean, LocalSessionFactory bean(provider of SF) , Tx manager
2.5 SC applies reflection - starts scanning - base pkg , containing spring beans (Controller - Service -DAO )
n starts their life cycle.
3. Details of hibernate-persistence.xml
3.1 Configure a spring bean , Apache supplied Basic Data Source  that represents DBCP.
Props - driver class , db url , user name ,password , init size of pool n max size of pool.
3.2 Configure LocalSessionFactory as a spring bean , to provide SessionFactory , that can be autowired n injected in DAO layer.
Props - packagesToScan : to scan the entities package.
Dependency - data source bean created in earlier step
3.3 Confgure HibernateTransactionManager as a spring bean.
Dependency - LocalSessionFactoryBean 
Why - To automatically manage transactions (resulting in reduced boilerplate code in DAO layer)
3.4 Enable annotation support for txs
(i.e manage txs using @Transactional)

4. JSTL Action for URL rewriting + generating URLs relative to current context path
<c:url var="attrName" value="url"/>


5. Understood the efforts of the extensive configuration ?

Any solution - Enter Spring Boot
Readmes to refer 
5.1 "day15-data\day15_help\spring boot\spring-boot-steps.txt"
5.2 "day15-data\day15_help\spring boot\Why n What is spring boot.txt"

6.  Port existing web application(w/o boot) with spring boot
Dev Steps
1. import spring_boot_mvc template in your workspace

2. Edit DB password - application.properties (resources)

3. Add the properties (only for MVC based web app)
server.servlet.context-path=/ems
#To specify ViewResolver
spring.mvc.view.prefix=/WEB-INF/views/
spring.mvc.view.suffix=.jsp

4. Copy / Create layers
base package - com.ems
Under that
- com.ems.controller
- com.ems.service
- com.ems.dao 
Above spring managed beans
For Entities (managed by JPA implementor - Def -Hibernate)
- com.ems.entities

All of above pkges will be scanned auto.
These defaults can be modified using additional annotations
 - @ComponentScan , @EntityScan

5. Create / Copy view layer.(WEB-INF)


6. Problem - while accessing DAO layer (via Whitelable err page - Spring boot rendered err page)

In DAO - sessionFactory.getCurretSession()
Exception - org.hibernate.HibenrateException
-  No CurrentSessionContext configured

Cause - In Native(standalone) hibernate  , 
property - current_session_context_class : thread

With Spring Boot managed hibernate - it DOES NOT directly support Native Hibernate APIs(eg - org.hibernate.SessionFactory , Session)

Solution - Instead use it's abstraction
Replace Hibernate by JPA
Pkg - jakarata.persistence (DAO layer)
API - 
org.hibernate.SessionFactory(sub i/f) -> jakarata.persistence.EntityManagerFactory (super i/f)

org.hibernate.Session (sub i/f) -> jakarata.persistence.EntityManager(super i/f)

Earlier depcy of DAO
- @AutoWired 
private SessionFactory sf;
Now
@AutoWired 
private EntityManager manager;

Same API (Session inherits - persist-save , merge- update , find - find by PK , remove - delete , JPQL , createQuery , setParameter - same)


Alternative JPA annotation for D.I
@PersistenceContext
private EntityManager manager;



7. Create DAO layer 
- Spring Data JPA based.
7.1 public interface DepartmentDao extends JpaRepository<Department,Long>
{}

8. Request resp flow
URL -> http://host:port/ctx_path/
Resp - index.jsp

9. After clicking on the link ,
<a href="department/list">List All Departments</a>
Req URL - http://host:port/ctx_path/department/list
Resp - <WEB-INF>/views/dept/list.jsp

10. After choosing the dept (eg : Finance)
URL -http://host:port/ctx_path/emps/list -- cookies are accepted

Create Entity , DAO , Service ,Controller

11. Simpler way of sharing model attributes between Handler & View Layer
o.s.ui.Model - interface
- Represents holder of model attributes.
- You can specify to SC , a dependency of Model i/f
 -How 
 By adding Model as argument in the req handling method.
SC creates EMPTY map of model attributes & passes(injects) it to the method.
Prog (in Handler) class populates it with model attributes

Method of Model i/f
public Model addAttribute(String attrName,Object value)
Can use method chaining - multiple attributes.


12. To access request parameter from the Handler
Use method argument annotation
- @RequestParam
Eg @RequestParam(Long departmentId)
 - Long departmentId=Long.parseLong(request.getParameter("departmentId"));

Match rq param name with method arg. , typically 
otherwise will have to add name in @RequestParam















 
















7.  While Porting non spring boot app to spring boot app
Any problems noticed ?
Exception : org.hibernate.HibernateException
Root cause : no curnt session context configured!
(i.e unable to get current session from SessionFactory , in the DAO layer)
Reason : Spring boot  DOES NOT directly support native hibernate APIs
(eg : org.hibernate : SessionFactory , Session, Transaction....)

Soln : Replace Hibernate by it's specification : JPA (Java Persistence API)

8. Replace hibernate native APIs by JPA
Refer : "day15-data\day15_help\spring boot\diagrams\jpa-entitymgr-session-layers.png"
